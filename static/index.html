<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <meta name="twitter:widgets:link-color" content="#cc0000">
    <meta name="twitter:widgets:theme" content="light">
    <link href="css/common.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="shortcut icon" href="%PUBLIC_URL%/favicon.ico">
    <div class="container">
      <div class="page-header"><h2>Streaming tweets with Node.js + Redis Streams</h2></div>
    </div>
  </head>
  <body>
    <form class="form">
        <div class="input-group">
            <input type="text" class="form-control search-txt" placeholder="Search for a hashtag on Twitter..." value="#trump" />
            <span class="input-group-btn">
                <button type="button" class="btn btn-success btn-search">Start streaming</button>
                <!-- <input type="button" onclick="CreateTableFromJSON()" value="Create Table From JSON" />
                <p id="showData"></p> -->
            </span>

        </div>
      </form>   
    <!-- <script> -->

    <div id="output"></div>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
    <script language="javascript" type="text/javascript">
      var form = document.querySelector('.form');
      var output;

      function init() {
        output = document.getElementById("output");
        testWebSocket();
      }

      function testWebSocket() {
        websocket = new WebSocket('ws://localhost:4000');
        websocket.onopen = function(evt) { onOpen(evt) };
        websocket.onclose = function(evt) { onClose(evt) };
        websocket.onmessage = function(evt) { onMessage(evt) };
        websocket.onerror = function(evt) { onError(evt) };
      }

      function onOpen(evt){
        writeToScreen("CONNECTED");
        doSend("WebSocket rocks");
      }

      function onClose(evt) {
        writeToScreen("DISCONNECTED");
      }

      function onMessage(evt) {
        displayTweet(evt.data);
        // websocket.close();
      }

      function onError(evt) {
        writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
      }

      function doSend(message) {
        writeToScreen("SENT: " + message);
        websocket.send(message);
      }

      function writeToScreen(message) {
        var pre = document.createElement("p");
        if(typeof pre !=="undefined") {
          pre.style.wordWrap = "break-word";
          pre.innerHTML = message;
          output.appendChild(pre);
        }  
      }

      function displayTweet(message) {
        var obj = JSON.parse(message);
        // console.log(obj);
        var id = obj.id;
        var d_el = document.createElement("div");

        $(d_el).attr({
          "id": "tweet",
          "tweetID": obj.id
        });

        window.twttr.widgets.createTweet(
          obj.id, d_el,
          {
            conversation  : 'none',
            cards         : 'hidden',
            // linkColor     : '#cc0000',
            // thene         : 'light'
          })
          .then (function (el) {
            // console.log('Tweet added.');
            output.appendChild(el);
          }
        );
      }

      window.addEventListener("load", init, false);

    </script>  
    <script> src="client.js"</script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <div id="root"></div>
  </body>
</html>







